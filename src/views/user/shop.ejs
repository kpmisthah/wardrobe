<%- include('../../views/partials/userPartials/header') %>

    <style>
        /* Enhanced UI Styles */
        .filter-pill {
            display: inline-block;
            padding: 8px 16px;
            margin: 5px 5px 5px 0;
            background-color: #f5f5f5;
            border-radius: 25px;
            color: #555;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .filter-pill:hover {
            background-color: #e6e6e6;
            transform: translateY(-1px);
        }

        .filter-active {
            background-color: #717fe0 !important;
            color: white !important;
            box-shadow: 0 4px 10px rgba(113, 127, 224, 0.4);
        }

        .search-container-modern {
            background: white;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 5px 20px;
            border: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .search-container-modern:focus-within {
            box-shadow: 0 4px 20px rgba(113, 127, 224, 0.15);
            border-color: #717fe0;
        }

        .panel-modern {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #f0f0f0;
        }

        .filter-group-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 1px;
        }
    </style>

    <!-- Product Section -->
    <div class="bg0 m-t-23 p-b-140">
        <div class="container" style="margin-top: 6rem;">
            <div class="flex-w flex-sb-m p-b-52">
                <!-- Filter Buttons -->


                <!-- Breadcrumb Navigation -->
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Shop</li>
                    </ol>
                </nav>

                <!-- Search and Filter Toggles -->
                <div class="flex-w flex-c-m m-tb-10">
                    <div
                        class="flex-c-m stext-106 cl6 size-104 bor4 pointer hov-btn3 trans-04 m-r-8 m-tb-4 js-show-filter">
                        <i class="icon-filter cl2 m-r-6 fs-15 trans-04 zmdi zmdi-filter-list"></i>
                        <i class="icon-close-filter cl2 m-r-6 fs-15 trans-04 zmdi zmdi-close dis-none"></i>
                        Filter
                    </div>

                    <div class="flex-c-m stext-106 cl6 size-105 bor4 pointer hov-btn3 trans-04 m-tb-4 js-show-search">
                        <i class="icon-search cl2 m-r-6 fs-15 trans-04 zmdi zmdi-search"></i>
                        <i class="icon-close-search cl2 m-r-6 fs-15 trans-04 zmdi zmdi-close dis-none"></i>
                        Search
                    </div>
                </div>

                <!-- Enhanced Search Panel -->
                <div class="dis-none panel-search panel-modern w-full p-t-10 p-b-15">
                    <div class="search-container-modern dis-flex p-l-15">
                        <button class="size-113 flex-c-m fs-16 cl2 hov-cl1 trans-04">
                            <i class="zmdi zmdi-search"></i>
                        </button>
                        <input id="searchInput" class="mtext-107 cl2 size-114 plh2 p-r-15" type="text"
                            name="search-product" placeholder="Search by product name, category, or description"
                            value="<%= searchQuery || '' %>">
                        <button id="clearSearch" class="size-113 flex-c-m fs-16 cl2 hov-cl1 trans-04"
                            style="display: none;">
                            <i class="zmdi zmdi-close"></i>
                        </button>
                    </div>
                </div>

                <div class="flex-w flex-c-m m-tb-10">
                    <button class="flex-c-m stext-106 cl6 size-104 bor4 pointer hov-btn3 trans-04 m-r-8 m-tb-4"
                        onclick="clearAllFilters()">
                        Clear All Filters
                    </button>
                </div>

                <!-- Complete Filter Options -->
                <div class="dis-none panel-filter panel-modern w-full p-t-10">
                    <div class="wrap-filter flex-w w-full p-lr-40 p-t-27 p-lr-15-sm" style="background: transparent;">
                        <div class="filter-col1 p-r-15 p-b-27">
                            <div class="filter-group-title">Sort By</div>
                            <ul class="flex-w">
                                <li class="p-b-6"><a
                                        class="filter-pill <%= sortOption === 'default' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('sort', 'default', this)">Default</a></li>
                                <li class="p-b-6"><a
                                        class="filter-pill <%= sortOption === 'new' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('sort', 'new', this)">Newness</a></li>
                                <li class="p-b-6"><a
                                        class="filter-pill <%= sortOption === 'priceLowtoHigh' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('sort', 'priceLowtoHigh', this)">Price: Low to High</a>
                                </li>
                                <li class="p-b-6"><a
                                        class="filter-pill <%= sortOption === 'priceHightoLow' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('sort', 'priceHightoLow', this)">Price: High to Low</a>
                                </li>
                            </ul>
                        </div>

                        <div class="filter-col2 p-r-15 p-b-27">
                            <div class="filter-group-title">Price</div>
                            <ul class="flex-w">
                                <li class="p-b-6"><a class="filter-pill <%= price === 'all' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('price', 'all', this)">All</a></li>
                                <li class="p-b-6"><a
                                        class="filter-pill <%= price === 'below-1500' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('price', 'below-1500', this)">Below ₹1500.00</a></li>
                                <li class="p-b-6"><a
                                        class="filter-pill <%= price === '1500-2000' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('price', '1500-2000', this)"> ₹1500.00 - ₹2000.00</a></li>
                                <li class="p-b-6"><a
                                        class="filter-pill <%= price === '2000-2500' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('price', '2000-2500', this)"> ₹2000.00 - ₹2500.00</a></li>
                                <li class="p-b-6"><a
                                        class="filter-pill <%= price === '2500-3000' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('price', '2500-3000', this)"> ₹2500.00 - ₹3000.00</a></li>
                                <li class="p-b-6"><a
                                        class="filter-pill <%= price === '3000-4000' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('price', '3000-4000', this)"> ₹3000.00 - ₹4000.00</a></li>
                                <li class="p-b-6"><a
                                        class="filter-pill <%= price === 'Above4000' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('price', 'Above4000', this)"> ₹4000.00+</a></li>
                            </ul>
                        </div>

                        <div class="filter-col3 p-r-15 p-b-27">
                            <div class="filter-group-title">Stock Availability</div>
                            <ul class="flex-w">
                                <li class="p-b-6"><a
                                        class="filter-pill <%= availability === 'Available' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('availability', 'Available', this)">Available</a></li>
                                <li class="p-b-6"><a
                                        class="filter-pill <%= availability === 'Unavailable' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('availability', 'Unavailable', this)">Out of Stock</a></li>
                            </ul>
                        </div>

                        <div class="filter-col4 p-r-15 p-b-27">
                            <div class="filter-group-title">Alphabetical</div>
                            <ul class="flex-w">
                                <li class="p-b-6"><a
                                        class="filter-pill <%= sortOption === 'alphabetical' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('sort', 'alphabetical', this)">Alphabetical (A-Z)</a></li>
                                <li class="p-b-6"><a
                                        class="filter-pill <%= sortOption === 'reverseAlphabetical' ? 'filter-active' : '' %>"
                                        onclick="applyFilter('sort', 'reverseAlphabetical', this)">Alphabetical
                                        (Z-A)</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Product Grid -->
            <div class="row isotope-grid">
                <% products.forEach(value=> { %>
                    <div
                        class="col-sm-6 col-md-4 col-lg-3 p-b-35 isotope-item <%= value.category ? value.category.name.toLowerCase() : 'uncategorized' %>">
                        <div class="block2">
                            <div class="block2-pic hov-img0">
                                <img src="/uploads/product-images/<%= value.productImage[0] %>" alt="IMG-PRODUCT">
                                <a href="/productDetails?id=<%= value._id %>"
                                    class="block2-btn flex-c-m stext-103 cl2 size-102 bg0 bor2 hov-btn1 p-lr-15 trans-04">
                                    Quick View
                                </a>
                            </div>
                            <div class="block2-txt flex-w flex-t p-t-14">
                                <div class="block2-txt-child1 flex-col-l">
                                    <a href="/productDetails?id=<%= value._id %>"
                                        class="stext-104 cl4 hov-cl1 trans-04 js-name-b2 p-b-6">
                                        <%= value.name %>
                                    </a>
                                    <span class="stext-105 cl3">₹<%= value.salePrice %></span>
                                    <small class="text-muted">
                                        <%= value.category ? value.category.name : 'Uncategorized' %>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% }) %>
            </div>

            <!-- Pagination -->
            <nav aria-label="Page navigation" class="pagination-container">
                <ul class="pagination justify-content-center">
                    <% for (let i=1; i <=totalpage; i++) { %>
                        <li class="page-item <%= page === i ? 'active' : '' %>">
                            <a class="page-link" href="javascript:void(0)" onclick="applyFilter('page', <%= i %>)">
                                <%= i %>
                            </a>
                        </li>
                        <% } %>
                </ul>
            </nav>
        </div>
    </div>

    <script>
        // Hide loader when the content is fully loaded
        window.addEventListener('load', function () {
            var loader = document.getElementById('loader');
            loader.style.display = 'none';
        });

        // Search Input handling
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent default form submission or reload
                    applyFilter('search', this.value);
                }
            });

            // Search button click
            const searchBtn = document.querySelector('.search-container-modern button');
            if (searchBtn) {
                searchBtn.addEventListener('click', function () {
                    applyFilter('search', searchInput.value);
                })
            }

            // Handle clear search button
            const clearSearchBtn = document.getElementById('clearSearch');

            // Initial check to show/hide clear button
            if (searchInput.value) {
                clearSearchBtn.style.display = 'flex';
            }

            // Update clear button visibility on input
            searchInput.addEventListener('input', function (e) {
                if (this.value === '') {
                    // Optional: Auto-search on clear? users usually prefer manual clear
                    clearSearchBtn.style.display = 'none';
                } else {
                    clearSearchBtn.style.display = 'flex';
                }
            });

            // Clear button click handler
            clearSearchBtn.addEventListener('click', function () {
                searchInput.value = '';
                applyFilter('search', '');
                this.style.display = 'none';
            });
        }

        async function clearAllFilters() {
            // Reset URL parameters
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';

            // Clear all params by navigating to base path with ajax=true
            const newUrl = window.location.pathname;
            const fetchUrl = `${newUrl}?ajax=true`;

            // Clear UI Active States
            document.querySelectorAll('.filter-active, .how-active1').forEach(el => {
                el.classList.remove('filter-active', 'how-active1');
            });
            // Set 'All Products' category active by default
            const allProductsBtn = document.querySelector('.filter-tope-group button');
            if (allProductsBtn) allProductsBtn.classList.add('how-active1');

            // Clear search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = '';
            const clearSearchBtn = document.getElementById('clearSearch');
            if (clearSearchBtn) clearSearchBtn.style.display = 'none';

            try {
                const response = await fetch(fetchUrl, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateProductGrid(data.products);
                    updatePagination(data.currentPage, data.totalPages, new URLSearchParams());

                    // Update URL to clean state
                    window.history.pushState({}, '', newUrl);
                }
            } catch (error) {
                console.error('Error clearing filters:', error);
            } finally {
                loader.style.display = 'none';
            }
        }

        async function applyFilter(filterName, filterValue, element) {
            console.log('applyFilter called:', filterName, filterValue);

            const loader = document.getElementById('loader');
            loader.style.display = 'flex';

            const urlParams = new URLSearchParams(window.location.search);
            let currentVal = urlParams.get(filterName);

            // Toggle Logic: If clicking the same value, remove the filter
            // Exception: 'page' and 'search' shouldn't just toggle off like buttons
            // Exception: 'category' with empty string means 'All', so we can set it. 
            // But if user clicks 'Women' and it's already 'Women', we might want to unset it (go to All).
            if (filterName !== 'page' && filterName !== 'search') {
                if (currentVal === filterValue && filterValue !== '') {
                    // Toggle off
                    urlParams.delete(filterName);
                    // If we toggled off category, we are effectively going to "All"
                    if (filterName === 'category') {
                        // Do nothing, just deleting the param is enough for "All"
                    }
                } else {
                    // Set new value
                    urlParams.set(filterName, filterValue);
                }
            } else if (filterName === 'search') {
                if (!filterValue) {
                    urlParams.delete('search');
                } else {
                    urlParams.set('search', filterValue);
                }
            } else if (filterName === 'page') {
                urlParams.set('page', filterValue);
            }

            // Special case handling for 'All' price or empty category
            if (filterName === 'price' && filterValue === 'all') {
                urlParams.delete('price');
            }
            if (filterName === 'category' && filterValue === '') {
                urlParams.delete('category');
            }


            // Reset page to 1 when filtering, except when changing page itself
            if (filterName !== 'page') {
                urlParams.set('page', 1);
            }

            // UI Update for Active State (Optimistic Update)
            if (element) {
                let container;
                let activeClass = 'filter-active';

                if (filterName === 'category') {
                    activeClass = 'how-active1';
                    container = element.closest('.filter-tope-group');
                } else {
                    container = element.closest('ul');
                }

                if (container) {
                    // 1. Remove active class from siblings
                    const siblings = container.querySelectorAll(filterName === 'category' ? 'button' : '.filter-pill');
                    siblings.forEach(el => el.classList.remove(activeClass));

                    // 2. Add active class ONLY if we didn't just toggle it off
                    // We check if the param is still present in the updated urlParams
                    // Exception: "All Products" (empty category) should be active if category param is missing
                    const isParamSet = urlParams.has(filterName);
                    const isAllCategory = filterName === 'category' && !isParamSet;

                    if (isParamSet || isAllCategory) {
                        // Only add active class if we set a specific value, OR if it's the "All" button
                        if (filterName === 'category' && !isParamSet) {
                            // This is the "All Products" button case
                            if (filterValue === '') element.classList.add(activeClass);
                        } else {
                            element.classList.add(activeClass);
                        }
                    } else if (filterName === 'category' && !isParamSet) {
                        // If we toggled off a specific category, find the "All" button and activate it
                        const allBtn = container.querySelector('button[onclick*="\'\'"]');
                        if (allBtn) allBtn.classList.add(activeClass);
                    }
                }
            }

            // Preserve search if we are clicking other filters
            const currentSearchInput = document.getElementById('searchInput');
            if (currentSearchInput && filterName !== 'search') {
                const searchVal = currentSearchInput.value;
                if (searchVal) {
                    urlParams.set('search', searchVal);
                }
            }

            const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
            const fetchUrl = `${newUrl}&ajax=true`;
            console.log('Fetching:', fetchUrl);

            try {
                const response = await fetch(fetchUrl, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const data = await response.json();
                        updateProductGrid(data.products);
                        updatePagination(data.currentPage, data.totalPages, urlParams);
                        window.history.pushState({}, '', newUrl);
                    } else {
                        // Fallback if HTML returned
                        window.location.href = newUrl;
                    }
                } else {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                }
            } catch (error) {
                console.error('Error fetching products:', error);
            } finally {
                loader.style.display = 'none';
            }
        }

        function updateProductGrid(products) {
            const grid = document.querySelector('.isotope-grid');
            if (!products || products.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center p-5"><h3>No products found</h3></div>';
                return;
            }

            grid.innerHTML = products.map(product => `
                <div class="col-sm-6 col-md-4 col-lg-3 p-b-35 isotope-item ${product.category ? product.category.name.toLowerCase() : 'uncategorized'}">
                    <div class="block2">
                        <div class="block2-pic hov-img0">
                            <img src="/uploads/product-images/${product.productImage[0]}" alt="IMG-PRODUCT">
                            <a href="/productDetails?id=${product._id}" 
                               class="block2-btn flex-c-m stext-103 cl2 size-102 bg0 bor2 hov-btn1 p-lr-15 trans-04">
                                Quick View
                            </a>
                        </div>
                        <div class="block2-txt flex-w flex-t p-t-14">
                            <div class="block2-txt-child1 flex-col-l">
                                <a href="/productDetails?id=${product._id}" 
                                   class="stext-104 cl4 hov-cl1 trans-04 js-name-b2 p-b-6">
                                    ${product.name}
                                </a>
                                <span class="stext-105 cl3">₹${product.salePrice}</span>
                                <small class="text-muted">
                                    ${product.category ? product.category.name : 'Uncategorized'}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updatePagination(currentPage, totalPages, urlParams) {
            const paginationContainer = document.querySelector('.pagination');
            if (!paginationContainer) return;

            let paginationHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                // Ensure we passed the integer
                paginationHTML += `
                    <li class="page-item ${currentPage === i ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0)" onclick="applyFilter('page', ${i})">${i}</a>
                    </li>
                `;
            }
            paginationContainer.innerHTML = paginationHTML;
        }
    </script>
    <script src="/javascript/cartHandler.js"></script>

    <%- include('../../views/partials/userPartials/footer') %>